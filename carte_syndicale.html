<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartographie des Élections Syndicales</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- DataTables CSS & JS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- DataTables Buttons Extension -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.print.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="js/table-filter.js"></script>
    <link rel="stylesheet" href="css/animated-background.css">
    <script src="js/animated-background.js"></script>
    
    <!-- Leaflet CSS et JS -->
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    <style>
        body {
            padding: 20px;
        }
        .container {
            max-width: 1200px;
        }
        #map-container {
            position: relative;
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* Styles pour le mode présentation */
        .fullscreen-mode #map-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            border: none;
            border-radius: 0;
        }
        
        .fullscreen-mode .container,
        .fullscreen-mode .row,
        .fullscreen-mode .col-md-9 {
            width: 100%;
            max-width: 100%;
            padding: 0;
            margin: 0;
        }
        
        .fullscreen-mode .selector-container,
        .fullscreen-mode .col-md-3,
        .fullscreen-mode #entreprises-container,
        .fullscreen-mode .legend {
            display: none;
        }
        
        .fullscreen-mode .leaflet-control-zoom {
            margin-top: 50px;
        }
        
        #presentation-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        #presentation-btn:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        #exit-fullscreen-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            display: none;
        }
        
        /* Styles pour le mode sombre */
        #dark-mode-toggle {
            position: fixed;
            top: 10px;
            right: 60px;
            z-index: 1000;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        
        #dark-mode-toggle:hover {
            background-color: #f8f9fa;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* Styles pour le mode sombre */
        body {
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        
        body.dark-mode .container {
            background-color: #121212;
        }
        
        .card,
        .stats-box,
        .selector-container,
        .legend,
        .list-group-item,
        .btn,
        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip,
        .leaflet-control-zoom a {
            transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease, box-shadow 0.3s ease;
        }
        
        body.dark-mode .card,
        body.dark-mode .stats-box,
        body.dark-mode .selector-container,
        body.dark-mode .legend {
            background-color: #1e1e1e;
            border-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .card-header {
            background-color: #333;
            color: #e0e0e0;
        }
        
        body.dark-mode .card-body {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        
        body.dark-mode .list-group-item {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border-color: #333;
        }
        
        body.dark-mode .list-group-item:hover {
            background-color: #2c2c2c;
        }
        
        body.dark-mode .stats-label {
            color: #aaa;
        }
        
        body.dark-mode table {
            color: #e0e0e0;
        }
        
        body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        body.dark-mode .table-hover tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.075);
        }
        
        /* Adapter la carte pour le mode sombre */
        body.dark-mode .leaflet-tile-pane {
            filter: invert(1) hue-rotate(180deg) brightness(0.8) contrast(1.2);
        }
        
        body.dark-mode .leaflet-control-zoom a {
            background-color: #333;
            color: #e0e0e0;
            border-color: #444;
        }
        
        body.dark-mode .leaflet-control-zoom a:hover {
            background-color: #444;
        }
        
        body.dark-mode .leaflet-popup-content-wrapper,
        body.dark-mode .leaflet-popup-tip {
            background-color: #1e1e1e;
            color: #e0e0e0;
            border-color: #333;
        }
        
        body.dark-mode #presentation-btn,
        body.dark-mode #dark-mode-toggle,
        body.dark-mode #exit-fullscreen-btn {
            background-color: #333;
            color: #e0e0e0;
            border-color: #444;
        }
        
        body.dark-mode #presentation-btn:hover,
        body.dark-mode #dark-mode-toggle:hover,
        body.dark-mode #exit-fullscreen-btn:hover {
            background-color: #444;
        }
        .departement {
            stroke: #FFF;
            stroke-width: 0.5;
            transition: fill 0.5s ease-in-out, stroke-width 0.3s ease;
        }
        .departement:hover {
            stroke: #000;
            stroke-width: 1.5;
        }
        .selected-dept {
            stroke: #000;
            stroke-width: 2;
        }
        .tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            pointer-events: none;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 1000;
            display: none;
        }
        .selector-container {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn-selector {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .btn-selector.active {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.5);
        }
        .stats-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }
        
        .stats-box:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .stats-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .stats-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .stats-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .legend {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 5px;
            border: 1px solid #ddd;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 10px;
            font-size: 0.8rem;
        }
        #color-legend {
            padding: 10px;
        }
        #entreprises-container {
            margin-top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .college-badge {
            font-size: 0.8rem;
            padding: 3px 8px;
        }
        .highlight-section {
            animation: highlight-pulse 1.5s ease-in-out 2;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.7);
            border: 2px solid #dc3545 !important;
        }
        @keyframes highlight-pulse {
            0% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 25px rgba(220, 53, 69, 0.9); }
            100% { box-shadow: 0 0 15px rgba(220, 53, 69, 0.7); }
        }
        .card {
            margin-bottom: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .highlight-section {
            animation: highlight 2s ease;
        }
        
        @keyframes highlight {
            0% { box-shadow: 0 0 0 0 rgba(0,123,255,0); }
            20% { box-shadow: 0 0 20px 10px rgba(0,123,255,0.5); }
            100% { box-shadow: 0 0 0 0 rgba(0,123,255,0); }
        }
        
        /* Animations pour les lignes de tableau */
        .table-row-animate {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        
        .table-row-animate:hover {
            transform: translateX(5px);
            background-color: rgba(0,123,255,0.1) !important;
        }
        
        /* Animation pour les changements de page */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-body {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Animation pour les boutons */
        .btn {
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Animation pour les popups de la carte */
        .leaflet-popup {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .leaflet-popup-content-wrapper {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- Les formes seront ajoutées par le script -->
    <div class="container">
        <h1 class="mb-4 text-center">Cartographie des Élections Syndicales</h1>
        <div class="alert alert-danger">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <img src="logo-cgt.png" alt="Logo CGT" style="max-height: 60px;" class="img-fluid">
                </div>
                <div class="col-md-10">
                    <h4 class="mb-2">Analyse des données issues de la mesure de représentativité du 8 avril 2025 pour le cycle 4</h4>
                    <p class="mb-0"><strong>Objectif :</strong> Cette carte interactive permet de visualiser les résultats des élections syndicales par département. Cliquez sur un département pour voir les détails des PV et analyser la présence syndicale.</p>
                    <p class="mb-0"><strong>Note :</strong> Dans les départements, les voix agricoles sont comptées mais pas les voix TPE.</p>
                </div>
            </div>
        </div>
        <h4 id="map-title" class="text-center mb-3">Nombre de scrutins par département</h4>

        <!-- Sélecteurs -->
        <div class="selector-container card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Filtres et sélection</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-12">
                        <h5>Syndicat</h5>
                        <div id="syndicat-selector" class="d-flex flex-wrap">
                            <button class="btn btn-outline-primary btn-selector active" data-value="all">Tous</button>
                            <button class="btn btn-outline-danger btn-selector" data-value="CGT">CGT</button>
                            <button class="btn btn-outline-info btn-selector" data-value="CFDT">CFDT</button>
                            <button class="btn btn-outline-warning btn-selector" data-value="CGT-FO">CGT-FO</button>
                            <button class="btn btn-outline-primary btn-selector" data-value="CFTC">CFTC</button>
                            <button class="btn btn-outline-secondary btn-selector" data-value="CFE-CGC">CFE-CGC</button>
                            <button class="btn btn-outline-success btn-selector" data-value="SOLIDAIRES">SOLIDAIRES</button>
                            <button class="btn btn-outline-dark btn-selector" data-value="UNSA">UNSA</button>
                            <button class="btn btn-outline-secondary btn-selector" data-value="AUTRES">AUTRES</button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <h5>Mode de visualisation</h5>
                        <div id="visualisation-selector" class="d-flex flex-wrap">
                            <button class="btn btn-outline-primary btn-visualisation active" data-value="syndicats">Syndicats dominants</button>
                            <button class="btn btn-outline-success btn-visualisation" data-value="inscrits">Nombre d'inscrits</button>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12 text-center">
                        <a href="carte_data_csv.html" class="btn btn-success">Voir la carte simplifiée</a>
                    </div>
                </div>
                <!-- Filtre par collège supprimé pour simplifier l'interface -->
            </div>
        </div>

        <div class="row">
            <div class="col-md-9">
                <div id="map-container">
                    <button id="presentation-btn" title="Mode présentation">
                        <i class="bi bi-arrows-fullscreen"></i> Mode présentation
                    </button>
                    <button id="dark-mode-toggle" title="Mode sombre/clair">
                        <i class="bi bi-moon"></i>
                    </button>
                    <div id="tooltip" class="tooltip"></div>
                </div>
                <button id="exit-fullscreen-btn" title="Quitter le mode présentation">
                    <i class="bi bi-fullscreen-exit"></i> Quitter
                </button>
                <div class="legend mt-3">
                    <h6>Légende</h6>
                    <div id="color-legend"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-box">
                    <div class="stats-title">Statistiques Nationales</div>
                    <div id="national-stats"></div>
                </div>
                <div class="stats-box">
                    <div class="stats-title">Répartition par syndicat dominant</div>
                    <div id="syndicat-dominance-stats"></div>
                </div>
                <div class="stats-box">
                    <h2 class="mt-4 mb-3">Top 5 Départements</h2>
                    <div id="top-departements" class="mb-4 card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">Départements avec le plus de scrutins</h5>
                        </div>
                        <div class="card-body">
                            <!-- Contenu généré dynamiquement -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="entreprises-container" class="mt-4"></div>
    </div>

    <script>
        // Variables globales
        let map;
        let departements = [];
        let selectedSyndicat = 'all';
        let selectedCollege = 'all';
        let selectedDepartement = null;
        let isFullscreenMode = false;
        let isDarkMode = false;
        let visualisationMode = 'syndicats'; // Modes: 'syndicats' ou 'inscrits'
        let statsNationales = {
            total_scrutins: 0,
            total_inscrits: 0,
            total_votants: 0,
            total_sve: 0,
            voix: {
                'CGT': 0,
                'CFDT': 0,
                'CGT-FO': 0,
                'CFTC': 0,
                'CFE-CGC': 0,
                'SOLIDAIRES': 0,
                'UNSA': 0,
                'AUTRES': 0
            }
        };
        let resultatsParDepartement = {};
        let detailsDepartements = {};
        // Palette de couleurs par syndicat
const colorPalettes = {
    'CGT': d3.interpolateReds,
    'CFDT': d3.interpolateBlues,
    'CGT-FO': d3.interpolateGreens,
    'CFTC': d3.interpolatePurples,
    'CFE-CGC': d3.interpolateOranges,
    'SOLIDAIRES': d3.interpolatePink,
    'UNSA': d3.interpolateYlGnBu,
    'AUTRES': d3.interpolateGreys,
    'all': d3.interpolatePuRd
};
let colorScale = d3.scaleSequential(colorPalettes['all']);

        // Fonction pour activer/désactiver le mode sombre
        function toggleDarkMode() {
            const body = document.body;
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            
            if (!isDarkMode) {
                // Activer le mode sombre
                body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="bi bi-sun"></i>';
                localStorage.setItem('darkMode', 'enabled');
                isDarkMode = true;
            } else {
                // Désactiver le mode sombre
                body.classList.remove('dark-mode');
                darkModeToggle.innerHTML = '<i class="bi bi-moon"></i>';
                localStorage.setItem('darkMode', 'disabled');
                isDarkMode = false;
            }
        }
        
        // Fonction pour activer/désactiver le mode présentation
        function togglePresentationMode() {
            const body = document.body;
            const mapContainer = document.getElementById('map-container');
            const exitBtn = document.getElementById('exit-fullscreen-btn');
            
            if (!isFullscreenMode) {
                // Activer le mode présentation
                body.classList.add('fullscreen-mode');
                exitBtn.style.display = 'block';
                
                // Utiliser l'API Fullscreen si disponible
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                } else if (document.documentElement.mozRequestFullScreen) {
                    document.documentElement.mozRequestFullScreen();
                } else if (document.documentElement.webkitRequestFullscreen) {
                    document.documentElement.webkitRequestFullscreen();
                } else if (document.documentElement.msRequestFullscreen) {
                    document.documentElement.msRequestFullscreen();
                }
                
                // Redimensionner la carte pour qu'elle s'adapte au nouvel espace
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 300);
                
                isFullscreenMode = true;
            } else {
                // Désactiver le mode présentation
                body.classList.remove('fullscreen-mode');
                exitBtn.style.display = 'none';
                
                // Quitter le mode plein écran si actif
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                // Redimensionner la carte pour qu'elle s'adapte au nouvel espace
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 300);
                
                isFullscreenMode = false;
            }
        }

        // Charger les données
        function loadData() {
            Promise.all([
                fetch('json_data_ordonnees/stats_regions.json'),
                fetch('json_data_ordonnees/resultats_departements.json'),
                fetch('assets/france-departements.json')
            ])
            .then(responses => {
                // Vérifier si toutes les réponses sont OK
                for (let response of responses) {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status} - ${response.statusText}`);
                    }
                }
                // Utiliser une fonction personnalisée pour parser le JSON et gérer les valeurs NaN
                return Promise.all(responses.map(response => 
                    response.text().then(text => {
                        // Remplacer les valeurs NaN par null pour permettre le parsing JSON
                        const validJsonText = text.replace(/: *NaN/g, ': null');
                        try {
                            return JSON.parse(validJsonText);
                        } catch (e) {
                            console.error('Erreur de parsing JSON:', e);
                            console.error('Texte JSON problématique:', validJsonText.substring(0, 200) + '...');
                            throw new Error(`Erreur de parsing JSON: ${e.message}`);
                        }
                    })
                ));
            })
            .then(([statsNat, resultatsDeptsData, geoData]) => {
                // Stocker les données
                resultatsParDepartement = resultatsDeptsData;
                
                // Calculer les statistiques nationales à partir des données des départements
                statsNationales = {
                    total_scrutins: 0,
                    total_inscrits: 0,
                    total_votants: 0,
                    total_sve: 0,
                    voix: {
                        'CGT': 0,
                        'CFDT': 0,
                        'CGT-FO': 0,
                        'CFTC': 0,
                        'CFE-CGC': 0,
                        'SOLIDAIRES': 0,
                        'UNSA': 0,
                        'AUTRES': 0
                    },
                    pourcentages: {}
                };
                
                // Agréger les données de tous les départements
                for (const deptCode in resultatsParDepartement) {
                    const dept = resultatsParDepartement[deptCode];
                    statsNationales.total_scrutins += dept.total_scrutins || 0;
                    statsNationales.total_inscrits += dept.total_inscrits || 0;
                    statsNationales.total_votants += dept.total_votants || 0;
                    statsNationales.total_sve += dept.total_sve || 0;
                    
                    // Agréger les voix par syndicat
                    for (const syndicat in statsNationales.voix) {
                        if (dept.voix && dept.voix[syndicat]) {
                            statsNationales.voix[syndicat] += dept.voix[syndicat];
                        }
                    }
                }
                
                // Calculer les pourcentages
                for (const syndicat in statsNationales.voix) {
                    statsNationales.pourcentages[syndicat] = statsNationales.total_sve > 0 ? 
                        (statsNationales.voix[syndicat] / statsNationales.total_sve * 100).toFixed(2) : 0;
                }
                
                console.log('Statistiques nationales calculées:', statsNationales);
                
                // Initialiser la carte avec les données géographiques
                initMap(geoData);
                
                // Mettre à jour les statistiques nationales
                updateNationalStats();
                
                // Mettre à jour le top 5 des départements
                updateTopDepartements();
                
                // Mettre à jour la coloration de la carte
                updateMapColoring();
                
                // Initialiser la légende des couleurs
                updateColorLegend();
            })
            .catch(error => {
                console.error('Erreur lors du chargement des données:', error);
                document.getElementById('map-container').innerHTML = 
                    `<div class="alert alert-danger">Erreur lors du chargement des données: ${error.message}</div>`;
            });
        }

        // Variables pour stocker les données TPE et AGRI
        let tpeData = [];
        let agriData = [];
        
        // Fonction pour initialiser la carte avec Leaflet
        function initMap(geoData) {
            // Supprimer la carte existante si elle existe déjà
            if (map) {
                map.remove();
            }
            
            // Initialiser la carte Leaflet
            map = L.map('map-container').setView([46.5, 2.5], 6);
            
            // Ajouter le fond de carte OpenStreetMap
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Ajouter directement la couche GeoJSON sans charger les données TPE/AGRI
            // pour éviter les erreurs
            initializeGeoJSON(geoData);
        }
        
        // Fonction pour initialiser la couche GeoJSON
        function initializeGeoJSON(geoData) {
            
            // Fonction pour déterminer la couleur du département en fonction du syndicat sélectionné
            function getColor(dept) {
                const deptData = resultatsParDepartement[dept];
                if (!deptData) return '#cccccc';
                
                // Mode de visualisation par nombre d'inscrits
                if (visualisationMode === 'inscrits') {
                    // Échelle de couleur en fonction du nombre d'inscrits
                    const inscrits = deptData.total_inscrits || 0;
                    if (inscrits > 100000) return '#081c15'; // Vert très foncé
                    if (inscrits > 50000) return '#1b4332'; // Vert foncé
                    if (inscrits > 25000) return '#2d6a4f'; // Vert moyen
                    if (inscrits > 10000) return '#40916c'; // Vert
                    if (inscrits > 5000) return '#52b788'; // Vert clair
                    if (inscrits > 1000) return '#74c69d'; // Vert très clair
                    return '#b7e4c7'; // Vert pâle
                }
                // Mode de visualisation par syndicats
                else if (selectedSyndicat === 'all') {
                    // Couleur basée sur le syndicat dominant
                    const syndicats = Object.keys(deptData.voix);
                    let maxVoix = 0;
                    let syndicatDominant = '';
                    
                    syndicats.forEach(syndicat => {
                        if (deptData.voix[syndicat] > maxVoix) {
                            maxVoix = deptData.voix[syndicat];
                            syndicatDominant = syndicat;
                        }
                    });
                    
                    switch (syndicatDominant) {
                        case 'CGT': return '#e63946';
                        case 'CFDT': return '#457b9d';
                        case 'CGT-FO': return '#f4a261';
                        case 'CFTC': return '#2a9d8f';
                        case 'CFE-CGC': return '#6c757d';
                        case 'SOLIDAIRES': return '#4caf50';
                        case 'UNSA': return '#9c27b0';
                        default: return '#aaaaaa';
                    }
                } else {
                    // Couleur basée sur le pourcentage du syndicat sélectionné
                    const pourcentage = deptData.pourcentages[selectedSyndicat] || 0;
                    
                    // Échelle de couleur en fonction du pourcentage
                    if (pourcentage > 40) return '#b71c1c'; // Rouge foncé
                    if (pourcentage > 30) return '#e53935'; // Rouge
                    if (pourcentage > 20) return '#ef5350'; // Rouge clair
                    if (pourcentage > 10) return '#ffcdd2'; // Rose clair
                    return '#f5f5f5'; // Gris très clair
                }
            }
            
            // Ajouter les départements à la carte
            const geojsonLayer = L.geoJSON(geoData, {
                style: function(feature) {
                    return {
                        fillColor: getColor(feature.properties.code),
                        weight: 1,
                        opacity: 1,
                        color: 'white',
                        dashArray: '3',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    const dept = feature.properties.code;
                    const deptData = resultatsParDepartement[dept];
                    
                    // Popup avec les informations du département
                    if (deptData) {
                        // Utiliser uniquement les données CSE comme demandé
                        let totalInscrits = Math.round(deptData.total_inscrits);
                        let totalVotants = Math.round(deptData.total_votants);
                        let totalScrutins = deptData.total_scrutins;
                        
                        // Calculer le taux de participation
                        const tauxParticipation = totalInscrits > 0 ? (totalVotants / totalInscrits * 100).toFixed(2) : 0;
                        
                        // Créer le contenu du popup avec les données CSE uniquement
                        let popupContent = `
                            <div>
                                <strong>${feature.properties.nom} (${dept})</strong><br>
                                Scrutins: ${totalScrutins}<br>
                                Inscrits: ${totalInscrits.toLocaleString()}<br>
                                Votants: ${totalVotants.toLocaleString()}<br>
                                Participation: ${tauxParticipation}%<br>
                                <small>Données uniquement des CSE</small><br>
                            </div>
                        `;
                        
                        if (selectedSyndicat !== 'all') {
                            popupContent = popupContent.replace('</div>', `Voix ${selectedSyndicat}: ${deptData.voix[selectedSyndicat].toLocaleString()} (${deptData.pourcentages[selectedSyndicat].toFixed(2)}%)<br></div>`);
                        }
                        
                        // Ajouter un bouton pour voir les PV du département
                        popupContent = popupContent.replace('</div>', `</div><div class="mt-2"><a href="pv_departement.html?dept=${dept}" class="btn btn-sm btn-primary" style="border-radius: 20px; padding: 5px 15px; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: all 0.3s ease; color: white;"><i class="fas fa-table me-1"></i> Voir les PV</a></div>`);
                        
                        layer.bindPopup(popupContent);
                    }
                    
                    // Événements de la souris
                    layer.on({
                        mouseover: function(e) {
                            const layer = e.target;
                            layer.setStyle({
                                weight: 3,
                                color: '#666',
                                dashArray: '',
                                fillOpacity: 0.9
                            });
                            layer.bringToFront();
                            
                            // Animation de survol avec CSS
                            if (e.target._path) {
                                e.target._path.style.transition = 'stroke-width 0.3s ease, fill-opacity 0.3s ease';
                            }
                            
                            // Ouvrir la popup au survol avec animation
                            layer.openPopup();
                        },
                        mouseout: function(e) {
                            geojsonLayer.resetStyle(e.target);
                            
                            // Ne pas fermer la popup au survol sortant si le département est sélectionné
                            if (selectedDepartement !== dept) {
                                e.target.closePopup();
                            }
                        },
                        click: function(e) {
                            // Désélectionner le département précédent
                            if (selectedDepartement) {
                                geojsonLayer.resetStyle(e.target);
                            }
                            
                            // Ouvrir la popup au clic et la maintenir ouverte
                            e.target.openPopup();
                            
                            // Sélectionner le nouveau département
                            selectedDepartement = dept;
                            
                            // Animation de zoom sur le département sélectionné
                            const bounds = e.target.getBounds();
                            map.flyToBounds(bounds, {
                                duration: 1, // durée en secondes
                                easeLinearity: 0.5
                            });
                            
                            // Charger les détails du département
                            if (!detailsDepartements[dept]) {
                                loadDepartementDetails(dept);
                            } else {
                                generateEntreprises(dept);
                            }
                            
                            // Faire défiler jusqu'à la section des PV
                            setTimeout(() => {
                                const pvSection = document.getElementById('pv-section');
                                if (pvSection) {
                                    // Assurer que le tableau est visible avant de défiler
                                    pvSection.style.display = 'block';
                                    // Défiler vers la section des PV
                                    pvSection.scrollIntoView({ behavior: 'smooth' });
                                    // Mettre en évidence la section
                                    pvSection.classList.add('highlight-section');
                                    setTimeout(() => {
                                        pvSection.classList.remove('highlight-section');
                                    }, 2000);
                                    
                                    // S'assurer que le tableau DataTables est correctement initialisé
                                    if ($.fn.DataTable && $.fn.DataTable.isDataTable && $.fn.DataTable.isDataTable('#pv-table')) {
                                        $('#pv-table').DataTable().columns.adjust().draw();
                                    }
                                }
                            }, 500);
                        }
                    });
                }
            }).addTo(map);
            
            // Stocker la couche GeoJSON pour pouvoir y accéder plus tard
            departements = geojsonLayer;
        }

        // Charger les détails d'un département
        function loadDepartementDetails(codeDept) {
            // Vérifier si les données sont déjà chargées
            if (detailsDepartements[codeDept]) {
                try {
                    generateEntreprises(codeDept);
                } catch (error) {
                    console.error(`Erreur lors de la génération des entreprises pour le département ${codeDept}:`, error);
                    document.getElementById('entreprises-container').innerHTML = 
                        `<div class="alert alert-danger">
                            <h4>Erreur lors du traitement des données</h4>
                            <p>Impossible de traiter les données pour le département ${codeDept}.</p>
                            <p>Détail: ${error.message || 'Erreur inconnue'}</p>
                        </div>`;
                }
                return;
            }
            
            // Charger les données du département
            fetch(`json_data/departement_${codeDept}.json`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status} - ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    try {
                        // Vérifier que les données sont valides
                        if (!data) {
                            throw new Error('Données vides');
                        }
                        
                        // Pour les départements problématiques, utiliser un tableau vide
                        if (['07', '11', '12'].includes(codeDept) && !Array.isArray(data)) {
                            console.warn(`Département ${codeDept} a des données non valides, utilisation d'un tableau vide`);
                            detailsDepartements[codeDept] = [];
                        } else if (!Array.isArray(data)) {
                            throw new Error('Format de données invalide (tableau attendu)');
                        } else {
                            // Stocker les données
                            detailsDepartements[codeDept] = data;
                        }
                        
                        // Générer la liste des entreprises
                        generateEntreprises(codeDept);
                    } catch (error) {
                        console.error(`Erreur lors du traitement des données pour le département ${codeDept}:`, error);
                        document.getElementById('entreprises-container').innerHTML = 
                            `<div class="alert alert-danger">
                                <h4>Erreur lors du traitement des données</h4>
                                <p>Impossible de traiter les données pour le département ${codeDept}.</p>
                                <p>Détail: ${error.message || 'Erreur inconnue'}</p>
                            </div>`;
                    }
                })
                .catch(error => {
                    console.error(`Erreur lors du chargement des données pour le département ${codeDept}:`, error);
                    document.getElementById('entreprises-container').innerHTML = 
                        `<div class="alert alert-danger">
                            <h4>Erreur lors du chargement des données</h4>
                            <p>Impossible de charger les données pour le département ${codeDept}.</p>
                            <p>Détail: ${error.message || 'Erreur inconnue'}</p>
                        </div>`;
                });
        }

        // Générer la liste des entreprises pour un département
        function generateEntreprises(codeDept) {
            const container = document.getElementById('entreprises-container');
            
            // Vérifier que le conteneur existe
            if (!container) {
                console.error(`Élément 'entreprises-container' introuvable`);
                return;
            }
            
            // Vérifier que les données du département existent
            const deptData = resultatsParDepartement[codeDept];
            if (!deptData) {
                container.innerHTML = `<div class="alert alert-danger">Données générales non disponibles pour le département ${codeDept}</div>`;
                return;
            }
            
            // Vérifier que la liste des PV existe
            const pvList = detailsDepartements[codeDept];
            if (!pvList || !Array.isArray(pvList) || pvList.length === 0) {
                container.innerHTML = `
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Département ${codeDept} - ${deptData.nom}</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <h4>Aucun PV disponible</h4>
                                <p>Aucun PV n'a été trouvé pour le département ${codeDept}.</p>
                                <p>Il est possible que les données pour ce département soient en cours de traitement ou non disponibles.</p>
                            </div>
                        </div>
                    </div>`;
                return;
            }
            
            // Filtrer les PV selon le syndicat et le collège sélectionnés
            let filteredPvs = [];
            
            try {
                // Copier la liste pour éviter de modifier l'original
                filteredPvs = [...pvList];
                
                // Filtrer par syndicat si nécessaire
                if (selectedSyndicat !== 'all') {
                    filteredPvs = filteredPvs.filter(pv => {
                        // Vérifier que pv.voix existe et que la propriété selectedSyndicat existe
                        return pv && pv.voix && typeof pv.voix === 'object' && 
                               selectedSyndicat in pv.voix && 
                               pv.voix[selectedSyndicat] && 
                               pv.voix[selectedSyndicat] > 0;
                    });
                }
                
                // Filtrer par collège si nécessaire
                if (selectedCollege !== 'all') {
                    filteredPvs = filteredPvs.filter(pv => {
                        return pv && pv.college && pv.college === selectedCollege;
                    });
                }
                
                // Trier les PV par raison sociale (avec gestion des valeurs null ou undefined)
                filteredPvs.sort((a, b) => {
                    try {
                        const raisonA = (a && a.raison_sociale) ? String(a.raison_sociale) : '';
                        const raisonB = (b && b.raison_sociale) ? String(b.raison_sociale) : '';
                        return raisonA.localeCompare(raisonB);
                    } catch (error) {
                        // En cas d'erreur de tri, retourner 0 (pas de changement d'ordre)
                        console.warn('Erreur de tri:', error);
                        return 0;
                    }
                });
            } catch (error) {
                console.error('Erreur lors du filtrage des PV:', error);
                // En cas d'erreur, utiliser une liste vide
                filteredPvs = [];
            }
            
            // Limiter à 100 PV pour des raisons de performance
            const displayPvs = filteredPvs.slice(0, 100);
            
            // Calculs pour le bandeau de synthèse (sur les PV filtrés par collège)
            // Déterminer les PV à utiliser pour les statistiques
            const statsFilteredPvs = selectedCollege === 'all' ? pvList : pvList.filter(pv => pv.college === selectedCollege);
            
            // Calculer les statistiques sur les PV filtrés par collège
            const totalInscrits = statsFilteredPvs.reduce((sum, pv) => sum + (pv.inscrits || 0), 0);
            const totalVotants = statsFilteredPvs.reduce((sum, pv) => sum + (pv.votants || 0), 0);
            const totalSVE = statsFilteredPvs.reduce((sum, pv) => sum + (pv.sve_total || 0), 0);
            const syndicats = ["CGT", "CFDT", "CGT-FO", "CFTC", "CFE-CGC", "SOLIDAIRES", "UNSA", "AUTRES"];
            const totalVoix = {};
            syndicats.forEach(s => {
                totalVoix[s] = statsFilteredPvs.reduce((sum, pv) => sum + (pv.voix && pv.voix[s] ? pv.voix[s] : 0), 0);
            });
            
            // Le nombre de PV affichés et la présence CGT sur les PV filtrés
            const nbPV = filteredPvs.length;
            const nbCGTPresent = filteredPvs.filter(pv => pv.voix && pv.voix.CGT > 0).length;
            const nbCGTAbsent = nbPV - nbCGTPresent;
            
            // Afficher le filtre de collège actif dans le titre
            const collegeTitle = selectedCollege === 'all' ? 'Tous les collèges' : selectedCollege;

            // Calculer les pourcentages pour chaque syndicat
            const pourcentages = {};
            syndicats.forEach(s => {
                pourcentages[s] = totalSVE > 0 ? (totalVoix[s] / totalSVE * 100).toFixed(2) : 0;
            });
            
            // Calculer les statistiques de participation
            const tauxParticipation = totalInscrits > 0 ? (totalVotants / totalInscrits * 100).toFixed(2) : 0;
            const tauxPresenceCGT = nbPV > 0 ? (nbCGTPresent / nbPV * 100).toFixed(2) : 0;
            const audienceCGT = pourcentages["CGT"];

            // Générer le HTML avec un affichage amélioré des globaux
            let html = `
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Département ${codeDept} - ${deptData.nom} - ${collegeTitle}</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card h-100 bg-light">
                                    <div class="card-body text-center">
                                        <h5>Participation</h5>
                                        <div class="display-4 mb-2 text-primary">${tauxParticipation}%</div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div><b>Inscrits :</b> ${Math.round(totalInscrits).toLocaleString()}</div>
                                                <div><b>Votants :</b> ${Math.round(totalVotants).toLocaleString()}</div>
                                                <div><b>SVE :</b> ${Math.round(totalSVE).toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 bg-light">
                                    <div class="card-body text-center">
                                        <h5>Présence CGT</h5>
                                        <div class="display-4 mb-2 text-success">${tauxPresenceCGT}%</div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div><b>PV totaux :</b> ${nbPV}</div>
                                                <div><b>CGT présente :</b> ${nbCGTPresent}</div>
                                                <div><b>CGT absente :</b> ${nbCGTAbsent}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card h-100 bg-light">
                                    <div class="card-body text-center">
                                        <h5>Audience CGT</h5>
                                        <div class="display-4 mb-2 text-danger">${audienceCGT}%</div>
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div><b>Voix CGT :</b> ${totalVoix['CGT'].toLocaleString()}</div>
                                                <div><b>Total SVE :</b> ${Math.round(totalSVE).toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h5 class="mb-3">Répartition des voix par organisation syndicale</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                        <thead class="table-light">
                                            <tr>
                                                ${syndicats.map(s => `<th class="text-center">${s}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                ${syndicats.map(s => `<td class="text-center">${totalVoix[s].toLocaleString()}</td>`).join('')}
                                            </tr>
                                            <tr>
                                                ${syndicats.map(s => `<td class="text-center fw-bold">${pourcentages[s]}%</td>`).join('')}
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="pv-section" class="card mb-4 border-secondary">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Liste des PV (${filteredPvs.length} PV trouvés${filteredPvs.length > 100 ? ', 100 premiers affichés' : ''}) - ${collegeTitle}</h5>
                        <button class="btn btn-light btn-sm" id="btn-export-csv">Exporter CSV</button>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">Rechercher</span>
                                    <input type="text" class="form-control" id="search-pv" placeholder="Filtrer par mot-clé...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">Trier par</span>
                                    <select class="form-select" id="sort-pv">
                                        <option value="raison_sociale">Raison sociale</option>
                                        <option value="ville">Ville</option>
                                        <option value="date">Date</option>
                                        <option value="inscrits">Inscrits</option>
                                        <option value="cgt">Voix CGT</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" id="sort-direction">↓</button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">Afficher</span>
                                    <select class="form-select" id="limit-pv">
                                        <option value="100">100 PV</option>
                                        <option value="200">200 PV</option>
                                        <option value="500">500 PV</option>
                                        <option value="1000">1000 PV</option>
                                        <option value="0">Tous</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="pv-table">
                                <thead class="table-dark">
                                    <tr>
                                        <th>SIRET</th>
                                        <th>Raison Sociale</th>
                                        <th>Ville</th>
                                        <th>IDCC</th>
                                        <th>Collège</th>
                                        <th>Date</th>
                                        <th>Inscrits</th>
                                        <th>Votants</th>
                                        <th>SVE</th>
                                        <th>CGT</th>
                                        <th>CFDT</th>
                                        <th>CGT-FO</th>
                                        <th>CFTC</th>
                                        <th>CFE-CGC</th>
                                        <th>SOLIDAIRES</th>
                                        <th>UNSA</th>
                                        <th>AUTRES</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            for (const pv of displayPvs) {
                // Correction du format de date
                let formattedDate = pv.date;
                // Si la date est au format YYYY-MM-DD, la convertir en format français
                if (pv.date && pv.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const dateParts = pv.date.split('-');
                    formattedDate = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                }
                
                html += `
                    <tr class="table-row-animate">
                        <td>${pv.siret}</td>
                        <td>${pv.raison_sociale}</td>
                        <td>${pv.ville}</td>
                        <td>${pv.idcc} - ${pv.lib_idcc}</td>
                        <td><span class="badge bg-secondary college-badge">${pv.college}</span></td>
                        <td>${formattedDate}</td>
                        <td>${pv.inscrits || 0}</td>
                        <td>${pv.votants || 0}</td>
                        <td>${pv.sve_total || 0}</td>
                        <td>${pv.voix && pv.voix.CGT ? pv.voix.CGT : 0}</td>
                        <td>${pv.voix && pv.voix.CFDT ? pv.voix.CFDT : 0}</td>
                        <td>${pv.voix && pv.voix["CGT-FO"] ? pv.voix["CGT-FO"] : 0}</td>
                        <td>${pv.voix && pv.voix.CFTC ? pv.voix.CFTC : 0}</td>
                        <td>${pv.voix && pv.voix["CFE-CGC"] ? pv.voix["CFE-CGC"] : 0}</td>
                        <td>${pv.voix && pv.voix.SOLIDAIRES ? pv.voix.SOLIDAIRES : 0}</td>
                        <td>${pv.voix && pv.voix.UNSA ? pv.voix.UNSA : 0}</td>
                        <td>${pv.voix && pv.voix.AUTRES ? pv.voix.AUTRES : 0}</td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Initialiser DataTables pour le tableau des PV
            try {
                // Détruire la table existante si elle existe déjà
                if ($.fn.DataTable.isDataTable('#pv-table')) {
                    $('#pv-table').DataTable().destroy();
                }
                
                // Initialiser DataTables avec des options avancées
                $('#pv-table').DataTable({
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json'
                    },
                    pageLength: 25,
                    lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tous"]],
                    responsive: true,
                    dom: 'Blfrtip',
                    buttons: [
                        {
                            extend: 'collection',
                            text: 'Exporter',
                            buttons: [
                                'copy', 
                                'csv', 
                                'excel', 
                                'pdf', 
                                'print'
                            ]
                        }
                    ],
                    // Optimisations de performance
                    deferRender: true,
                    scroller: true,
                    scrollY: '50vh',
                    // Définition des colonnes
                    columnDefs: [
                        { className: 'text-center', targets: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16] },
                        { 
                            targets: [9, 10, 11, 12, 13, 14, 15, 16],
                            render: function(data, type, row) {
                                if (type === 'display') {
                                    if (data > 0) {
                                        return '<span class="badge bg-success">' + data + '</span>';
                                    }
                                }
                                return data;
                            }
                        }
                    ],
                    // Styles personnalisés
                    initComplete: function() {
                        $('.dataTables_wrapper').addClass('pt-2');
                        $('.dt-buttons').addClass('mb-2');
                    }
                });
            } catch (error) {
                console.error("Erreur lors de l'initialisation de DataTables:", error);
                // Afficher un message d'erreur discret en bas du tableau
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-warning mt-2';
                errorMsg.innerHTML = `<small>Remarque: Certaines fonctionnalités avancées du tableau peuvent ne pas être disponibles.</small>`;
                document.querySelector('.table-responsive').appendChild(errorMsg);
            }
            
            // Initialiser les filtres et l'export CSV (pour la compatibilité avec le code existant)
            initTableFilters(filteredPvs, codeDept, deptData.nom);
        }

        // Mettre à jour la coloration de la carte avec Leaflet
        function updateMapColoring() {
            // Déterminer les valeurs pour l'échelle de couleurs
            let values = [];
            for (const deptCode in resultatsParDepartement) {
                const dept = resultatsParDepartement[deptCode];
                if (selectedSyndicat === 'all') {
                    values.push(dept.total_inscrits || 0);
                } else {
                    values.push(dept.pourcentages[selectedSyndicat]);
                }
            }
            
            // Mettre à jour le titre de la carte
            let mapTitle = document.getElementById('map-title');
            if (mapTitle) {
                if (selectedSyndicat === 'all') {
                    mapTitle.innerHTML = 'Nombre d\'inscrits par département';
                } else {
                    mapTitle.innerHTML = `Pourcentage de représentativité ${selectedSyndicat} par département`;
                }
            }
            
            // Fonction pour déterminer la couleur du département
            function getColor(deptCode) {
                const dept = resultatsParDepartement[deptCode];
                if (!dept) return '#f5f5f5';
                
                if (selectedSyndicat === 'all') {
                    // Échelle de couleurs pour le nombre d'inscrits
                    const inscrits = dept.total_inscrits || 0;
                    if (inscrits > 100000) return '#91003f';
                    if (inscrits > 50000) return '#ce1256';
                    if (inscrits > 20000) return '#e7298a';
                    if (inscrits > 10000) return '#df65b0';
                    if (inscrits > 5000) return '#c994c7';
                    if (inscrits > 1000) return '#d4b9da';
                    if (inscrits > 0) return '#e7e1ef';
                    return '#f7f4f9';
                } else {
                    // Échelle de couleurs pour les pourcentages
                    const pourcentage = dept.pourcentages[selectedSyndicat] || 0;
                    
                    // Définir des couleurs en fonction du syndicat sélectionné
                    let couleur1, couleur2, couleur3, couleur4, couleur5;
                    
                    switch(selectedSyndicat) {
                        case 'CGT':
                            couleur1 = '#ffebee'; couleur2 = '#ffcdd2'; couleur3 = '#ef9a9a'; 
                            couleur4 = '#e57373'; couleur5 = '#e53935';
                            break;
                        case 'CFDT':
                            couleur1 = '#e3f2fd'; couleur2 = '#bbdefb'; couleur3 = '#90caf9'; 
                            couleur4 = '#64b5f6'; couleur5 = '#1e88e5';
                            break;
                        case 'CGT-FO':
                            couleur1 = '#fffde7'; couleur2 = '#fff9c4'; couleur3 = '#fff59d'; 
                            couleur4 = '#ffee58'; couleur5 = '#fdd835';
                            break;
                        case 'CFTC':
                            couleur1 = '#e0f2f1'; couleur2 = '#b2dfdb'; couleur3 = '#80cbc4'; 
                            couleur4 = '#4db6ac'; couleur5 = '#00897b';
                            break;
                        case 'CFE-CGC':
                            couleur1 = '#f5f5f5'; couleur2 = '#e0e0e0'; couleur3 = '#bdbdbd'; 
                            couleur4 = '#9e9e9e'; couleur5 = '#616161';
                            break;
                        case 'SOLIDAIRES':
                            couleur1 = '#e8f5e9'; couleur2 = '#c8e6c9'; couleur3 = '#a5d6a7'; 
                            couleur4 = '#81c784'; couleur5 = '#43a047';
                            break;
                        case 'UNSA':
                            couleur1 = '#f3e5f5'; couleur2 = '#e1bee7'; couleur3 = '#ce93d8'; 
                            couleur4 = '#ba68c8'; couleur5 = '#8e24aa';
                            break;
                        default:
                            couleur1 = '#f5f5f5'; couleur2 = '#e0e0e0'; couleur3 = '#bdbdbd'; 
                            couleur4 = '#9e9e9e'; couleur5 = '#616161';
                    }
                    
                    if (pourcentage > 40) return couleur5;
                    if (pourcentage > 30) return couleur4;
                    if (pourcentage > 20) return couleur3;
                    if (pourcentage > 10) return couleur2;
                    return couleur1;
                }
            }
            
            // Mettre à jour les styles de tous les départements
            if (departements && departements.getLayers) {
                departements.getLayers().forEach(layer => {
                    const deptCode = layer.feature.properties.code;
                    layer.setStyle({
                        fillColor: getColor(deptCode),
                        weight: (deptCode === selectedDepartement) ? 4 : 1,
                        color: (deptCode === selectedDepartement) ? '#000' : 'white',
                        dashArray: (deptCode === selectedDepartement) ? '' : '3',
                        fillOpacity: (deptCode === selectedDepartement) ? 0.9 : 0.7
                    });
                });
            }
            
            // Mettre à jour la légende
            updateLegend(values);
        }
        
        // Fonction pour mettre à jour la légende
        function updateLegend(values) {
            const legendContainer = document.getElementById('color-legend');
            legendContainer.innerHTML = '';
            
            // Créer la légende en fonction du type de données
            if (selectedSyndicat === 'all') {
                // Légende pour le nombre d'inscrits avec des seuils prédéfinis
                const thresholds = [
                    0,
                    1000,
                    5000,
                    10000,
                    20000,
                    50000,
                    100000,
                    d3.max(values)
                ];
                
                const customColors = [
                    "#f7f4f9",
                    "#e7e1ef",
                    "#d4b9da",
                    "#c994c7",
                    "#df65b0",
                    "#e7298a",
                    "#ce1256",
                    "#91003f"
                ];
                
                const formattedThresholds = thresholds.map(d => Math.round(d).toLocaleString());
                
                const legendHTML = `
                    <div class="d-flex justify-content-between">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f5f5f5;"></div>
                            <span>Pas de données</span>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap mt-2">
                        ${customColors.map((color, i) => {
                            // Ne pas afficher le dernier seuil qui est le max
                            if (i < customColors.length - 1) {
                                return `<div class="legend-item mb-1">
                                    <div class="legend-color" style="background-color: ${color};"></div>
                                    <span>${formattedThresholds[i]} - ${formattedThresholds[i+1]}</span>
                                </div>`;
                            } else {
                                return `<div class="legend-item mb-1">
                                    <div class="legend-color" style="background-color: ${color};"></div>
                                    <span>> ${formattedThresholds[i-1]}</span>
                                </div>`;
                            }
                        }).join('')}
                    </div>
                `;
                
                legendContainer.innerHTML = legendHTML;
            } else {
                // Légende pour les pourcentages
                const thresholds = colorScale.quantiles();
                const formattedThresholds = [0, ...thresholds].map(d => d.toFixed(1) + '%');
                
                const legendHTML = `
                    <div class="d-flex justify-content-between">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #f5f5f5;"></div>
                            <span>Pas de données</span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <div>Moins représentatif</div>
                        <div class="d-flex">
                            ${colorScale.range().map((color, i) => {
                                return `<div class="legend-item">
                                    <div class="legend-color" style="background-color: ${color};"></div>
                                    <span>${i < formattedThresholds.length - 1 ? formattedThresholds[i] + ' - ' + formattedThresholds[i+1] : '> ' + formattedThresholds[i]}</span>
                                </div>`;
                            }).join('')}
                        </div>
                        <div>Plus représentatif</div>
                    </div>
                `;
                
                legendContainer.innerHTML = legendHTML;
            }
        }

        // Mettre à jour les statistiques nationales
        function updateNationalStats() {
            const container = document.getElementById('national-stats');
            
            // Format des nombres avec séparateur de milliers
            const formatNumber = (num) => Math.round(num).toLocaleString();
            
            // Générer le HTML
            const html = `
                <div class="stats-grid">
                    <div class="stats-item">
                        <div class="stats-value">${formatNumber(statsNationales.total_scrutins)}</div>
                        <div class="stats-label">Scrutins</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-value">${formatNumber(statsNationales.total_inscrits)}</div>
                        <div class="stats-label">Inscrits</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-value">${formatNumber(statsNationales.total_votants)}</div>
                        <div class="stats-label">Votants</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-value">${formatNumber(statsNationales.total_sve)}</div>
                        <div class="stats-label">SVE</div>
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Répartition des voix</h6>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Syndicat</th>
                                <th>Voix</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.keys(statsNationales.voix).map(syndicat => `
                                <tr>
                                    <td>${syndicat}</td>
                                    <td>${formatNumber(statsNationales.voix[syndicat])}</td>
                                    <td>${statsNationales.pourcentages[syndicat]}%</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Mettre à jour les statistiques de dominance par syndicat
            updateSyndicatDominanceStats();
        }
        
        // Mettre à jour la légende des couleurs
        function updateColorLegend() {
            const container = document.getElementById('color-legend');
            let html = '';
            
            if (visualisationMode === 'inscrits') {
                // Légende pour le mode nombre d'inscrits
                html = `<h6 class="mb-2">Nombre d'inscrits</h6>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #081c15;"></div>
                    <div>&gt; 100 000</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #1b4332;"></div>
                    <div>&gt; 50 000</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2d6a4f;"></div>
                    <div>&gt; 25 000</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #40916c;"></div>
                    <div>&gt; 10 000</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #52b788;"></div>
                    <div>&gt; 5 000</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #74c69d;"></div>
                    <div>&gt; 1 000</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #b7e4c7;"></div>
                    <div>&lt; 1 000</div>
                </div>`;
            } else if (selectedSyndicat === 'all') {
                // Légende pour le mode syndicats dominants
                html = `<h6 class="mb-2">Syndicat dominant</h6>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e63946;"></div>
                    <div>CGT</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #457b9d;"></div>
                    <div>CFDT</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f4a261;"></div>
                    <div>CGT-FO</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2a9d8f;"></div>
                    <div>CFTC</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #6c757d;"></div>
                    <div>CFE-CGC</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #4caf50;"></div>
                    <div>SOLIDAIRES</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9c27b0;"></div>
                    <div>UNSA</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #aaaaaa;"></div>
                    <div>AUTRES</div>
                </div>`;
            } else {
                // Légende pour un syndicat spécifique
                html = `<h6 class="mb-2">Pourcentage ${selectedSyndicat}</h6>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #b71c1c;"></div>
                    <div>&gt; 40%</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e53935;"></div>
                    <div>&gt; 30%</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ef5350;"></div>
                    <div>&gt; 20%</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffcdd2;"></div>
                    <div>&gt; 10%</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f5f5f5;"></div>
                    <div>&lt; 10%</div>
                </div>`;
            }
            
            container.innerHTML = html;
        }
        
        // Mettre à jour le top 5 des départements
        function updateTopDepartements() {
            const container = document.getElementById('top-departements').querySelector('.card-body');
            
            // Créer un tableau avec les départements
            let depts = [];
            
            for (const deptCode in resultatsParDepartement) {
                const dept = resultatsParDepartement[deptCode];
                
                depts.push({
                    code: deptCode,
                    nom: dept.nom,
                    value: selectedSyndicat === 'all' ? dept.total_scrutins : dept.pourcentages[selectedSyndicat]
                });
            }
            
            // Trier les départements par valeur décroissante
            depts.sort((a, b) => b.value - a.value);
            
            // Prendre les 5 premiers
            const top5 = depts.slice(0, 5);
            
            // Générer le HTML
            let html = '<div class="list-group">';
            
            for (const dept of top5) {
                const badgeClass = selectedSyndicat === 'all' ? 'bg-primary' : 'bg-danger';
                const valueDisplay = selectedSyndicat === 'all' ? (dept.value ? dept.value.toLocaleString() : '0') : (dept.value ? dept.value.toFixed(2) : '0') + '%';
                
                html += `
                    <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="event.preventDefault(); showDepartementDetails('${dept.code}')">
                        <div>
                            <strong>${dept.code}</strong> - ${dept.nom}
                        </div>
                        <span class="badge ${badgeClass} rounded-pill">${valueDisplay}</span>
                    </a>
                `;
            }
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Fonction pour calculer et afficher le nombre de départements où chaque syndicat est dominant
        function updateSyndicatDominanceStats() {
            const container = document.getElementById('syndicat-dominance-stats');
            
            // Compter les départements par syndicat dominant
            const syndicatCount = {
                'CGT': 0,
                'CFDT': 0,
                'CGT-FO': 0,
                'CFTC': 0,
                'CFE-CGC': 0,
                'SOLIDAIRES': 0,
                'UNSA': 0,
                'AUTRES': 0
            };
            
            // Parcourir tous les départements
            for (const deptCode in resultatsParDepartement) {
                const deptData = resultatsParDepartement[deptCode];
                if (!deptData || !deptData.voix) continue;
                
                // Trouver le syndicat dominant
                const syndicats = Object.keys(deptData.voix);
                let maxVoix = 0;
                let syndicatDominant = '';
                
                syndicats.forEach(syndicat => {
                    if (deptData.voix[syndicat] > maxVoix) {
                        maxVoix = deptData.voix[syndicat];
                        syndicatDominant = syndicat;
                    }
                });
                
                // Incrémenter le compteur pour ce syndicat
                if (syndicatDominant && syndicatCount.hasOwnProperty(syndicatDominant)) {
                    syndicatCount[syndicatDominant]++;
                }
            }
            
            // Calculer le total de départements
            const totalDepts = Object.values(syndicatCount).reduce((sum, count) => sum + count, 0);
            
            // Générer le HTML
            let html = `
                <div class="mt-2">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Syndicat</th>
                                <th>Départements</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Trier les syndicats par nombre de départements (du plus grand au plus petit)
            const sortedSyndicats = Object.keys(syndicatCount).sort((a, b) => syndicatCount[b] - syndicatCount[a]);
            
            for (const syndicat of sortedSyndicats) {
                const count = syndicatCount[syndicat];
                const percentage = totalDepts > 0 ? ((count / totalDepts) * 100).toFixed(1) : '0.0';
                
                // Définir une classe CSS pour mettre en évidence le syndicat
                let rowClass = '';
                if (syndicat === 'CGT') rowClass = 'table-danger';
                else if (syndicat === 'CFDT') rowClass = 'table-info';
                else if (syndicat === 'CGT-FO') rowClass = 'table-warning';
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${syndicat}</strong></td>
                        <td>${count}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                        <tfoot>
                            <tr class="table-secondary">
                                <td><strong>Total</strong></td>
                                <td><strong>${totalDepts}</strong></td>
                                <td>100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Gestionnaire d'événements pour les sélecteurs
        document.addEventListener('DOMContentLoaded', function() {
            // Sélecteur de syndicat
            document.querySelectorAll('#syndicat-selector .btn-selector').forEach(button => {
                button.addEventListener('click', function() {
                    // Désélectionner tous les boutons
                    document.querySelectorAll('#syndicat-selector .btn-selector').forEach(btn => {
                        btn.classList.remove('active', 'btn-primary');
                        btn.classList.add('btn-outline-primary');
                    });
                    // Sélectionner le nouveau bouton
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('active', 'btn-primary');
                    // Mettre à jour le syndicat sélectionné
                    selectedSyndicat = this.getAttribute('data-value');
                    // Mettre à jour la carte
                    updateMapColoring();
                    // Mettre à jour les statistiques
                    updateNationalStats();
                    // Mettre à jour le top 5 des départements
                    updateTopDepartements();
                    // Mettre à jour la légende des couleurs
                    updateColorLegend();
                    // Mettre à jour la liste des entreprises si un département est sélectionné
                    if (selectedDepartement) {
                        generateEntreprises(selectedDepartement);
                    }
                });
            });
            
            // Le filtre par collège a été supprimé, on définit selectedCollege à 'all' par défaut
            selectedCollege = 'all';
            
            // Ajouter les écouteurs d'événements pour le mode présentation
            document.getElementById('presentation-btn').addEventListener('click', togglePresentationMode);
            document.getElementById('exit-fullscreen-btn').addEventListener('click', togglePresentationMode);
            
            // Ajouter l'écouteur d'événement pour le mode sombre
            document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
            
            // Vérifier si le mode sombre était activé précédemment
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').innerHTML = '<i class="bi bi-sun"></i>';
                isDarkMode = true;
            }
            
            // Ajouter les écouteurs d'événements pour le sélecteur de mode de visualisation
            document.querySelectorAll('#visualisation-selector .btn-visualisation').forEach(button => {
                button.addEventListener('click', function() {
                    // Désélectionner tous les boutons
                    document.querySelectorAll('#visualisation-selector .btn-visualisation').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.classList.contains('btn-primary')) {
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-outline-primary');
                        }
                        if (btn.classList.contains('btn-success')) {
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-outline-success');
                        }
                    });
                    
                    // Sélectionner le nouveau bouton
                    this.classList.add('active');
                    if (this.classList.contains('btn-outline-primary')) {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                    }
                    if (this.classList.contains('btn-outline-success')) {
                        this.classList.remove('btn-outline-success');
                        this.classList.add('btn-success');
                    }
                    
                    // Mettre à jour le mode de visualisation
                    visualisationMode = this.getAttribute('data-value');
                    
                    // Mettre à jour le titre de la carte
                    if (visualisationMode === 'inscrits') {
                        document.getElementById('map-title').textContent = 'Nombre d\'inscrits par département';
                    } else {
                        document.getElementById('map-title').textContent = 'Syndicat dominant par département';
                    }
                    
                    // Mettre à jour la coloration de la carte
                    updateMapColoring();
                    
                    // Mettre à jour la légende des couleurs
                    updateColorLegend();
                });
            });
            
            // Gérer la sortie du mode plein écran avec la touche Echap
            document.addEventListener('fullscreenchange', function() {
                if (!document.fullscreenElement && isFullscreenMode) {
                    // L'utilisateur a quitté le mode plein écran avec Echap
                    document.body.classList.remove('fullscreen-mode');
                    document.getElementById('exit-fullscreen-btn').style.display = 'none';
                    isFullscreenMode = false;
                    
                    // Redimensionner la carte
                    setTimeout(() => {
                        if (map) map.invalidateSize();
                    }, 300);
                }
            });
            
            // Support pour différents navigateurs
            document.addEventListener('webkitfullscreenchange', function() {
                if (!document.webkitFullscreenElement && isFullscreenMode) {
                    document.body.classList.remove('fullscreen-mode');
                    document.getElementById('exit-fullscreen-btn').style.display = 'none';
                    isFullscreenMode = false;
                    setTimeout(() => { if (map) map.invalidateSize(); }, 300);
                }
            });
            
            document.addEventListener('mozfullscreenchange', function() {
                if (!document.mozFullScreenElement && isFullscreenMode) {
                    document.body.classList.remove('fullscreen-mode');
                    document.getElementById('exit-fullscreen-btn').style.display = 'none';
                    isFullscreenMode = false;
                    setTimeout(() => { if (map) map.invalidateSize(); }, 300);
                }
            });
            
            document.addEventListener('MSFullscreenChange', function() {
                if (!document.msFullscreenElement && isFullscreenMode) {
                    document.body.classList.remove('fullscreen-mode');
                    document.getElementById('exit-fullscreen-btn').style.display = 'none';
                    isFullscreenMode = false;
                    setTimeout(() => { if (map) map.invalidateSize(); }, 300);
                }
            });
            
            // Charger les données
            loadData();
        });
    </script>
</body>
</html>
